<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.1/dist/cdn.min.js"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"
      integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz"
      crossorigin="anonymous"
    ></script>
    <title>login</title>
    <script>
      document.addEventListener('htmx:configRequest', (e) => {
          const token = document.cookie.split('; ')
              .find(row => row.startsWith('token='))
              ?.split('=')[1];

          if (token) {
              e.detail.headers['Authorization'] = `Bearer ${token}`;
          }
      });
    </script>
  </head>
  <body>
    <main class="container grid place-items-center h-svh mx-auto py-16">
      <section class="w-sm mx-auto">
        <script defer>
          function login(event) {
              const form = event.target;
              const data = {
                  email: form.querySelector('[x-model="email"]').value,
                  pwd: form.querySelector('[x-model="pwd"]').value
              };

              fetch('/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              })
              .then(r => r.json())
              .then(res => {
                  if (res.status === 'authenticated') {
                      document.cookie = `token=${res.token}; path=/; max-age=3600; SameSite=Strict`;
                      window.location.href = '/workshop/profile';
                      return;
                  }

                  Alpine.store('app').error = res.message || 'Error de login';
              });
          }
        </script>
        <form
          hx-post="/api/auth/login"
          hx-swap="none"
          x-data="{ email: '', pwd: '' }"
          class="rounded-xl border-1 border-gray-300 bg-gray-400/20 py-4 px-2"
          @submit.prevent="login($event)"
        >
          <h1 class="text-4xl text-center font-bold">Inicia Seccion</h1>

          <div class="grid grid-cols-1 gap-4 py-4">
            <label for="email" class="flex flex-col gap-2">
              Email
              <input
                x-model="email"
                class="rounded-sm border-1 border-gray-300 px-2 py-1.5"
                id="email"
                name="email"
                type="text"
                value=""
                placeholder="e@gmail.com"
                required
              />
            </label>
            <label for="password" class="flex flex-col gap-2">
              <div class="flex flex-row flex-nowrap justify-between items-end">
                <span>Password</span>
                <a
                  class="text-xs underline"
                  href="/auth/restore-pwd"
                  target="_self"
                >
                  restablecer contraseña?
                </a>
              </div>
              <input
                x-model="pwd"
                class="rounded-sm border-1 border-gray-300 px-2 py-1.5"
                id="password"
                name="password"
                type="text"
                value=""
                placeholder="*******"
                required
              />
            </label>
          </div>
          <button
            type="submit"
            class="block text-center mx-auto rounded-xl bg-gray-300 hover:bg-gray-400 py-2 px-4 transition-all ease-in-out duration-300 cursor-pointer"
          >
            Iniciar seccion
          </button>
          <p class="text-xs text-center mt-4">
            ¿No tienes una cuenta? ve a
            <a class="font-bold underline" href="/auth/sign-up" target="_self"
              >Registrarte</a
            >
          </p>
        </form>
        <p class="text-xs text-center mt-2.5 opacity-75">
          Al continuar has aceptado nuestros <b>terminos y condiciones</b> y
          <b>politicas de privacidad</b>.
        </p>
      </section>
    </main>
  </body>
</html>
